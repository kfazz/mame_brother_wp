#!/usr/bin/make -f
# -*- makefile -*-
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
# Default/i386/amd64 options from sdlmame rules file by Cesare Falco.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

CFLAGS = -Wall -g

DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)

# Override relevant make variables in original makefile
DEB_MAME_OPTS = \
    OPT_FLAGS="-D'INI_PATH=\"/etc/mame\"'" \
    FULLNAME=mame \
    TARGET=mame \
    SUBTARGET=mame \
    OSD=sdl \
    CROSS_BUILD_OSD= \
    TARGETOS=unix \
    PREFIX= \
    SUFFIX= \
    DEBUG= \
    PROFILER= \
    NOWERROR= \
    MACOSX_USE_LIBSDL= \
    BUILD_EXPAT= \
    BUILD_ZLIB= \
    SYMBOLS= \
    SYMLEVEL= \
    DUMPSYM= \
    PROFILE= \
    MAP= \
    VERBOSE= \
    OPTIMIZE=3 \
    DISTRO=gcc44-generic

# Override make variables for specific archs
ifeq ($(DEB_HOST_ARCH),i386)
DEB_MAME_OPTS += \
    ARCHOPTS=-march=pentium2 \
    FORCE_DRC_C_BACKEND= \
    PTR64= \
    BIGENDIAN=
endif

ifeq ($(DEB_HOST_ARCH),amd64)
DEB_MAME_OPTS += \
    ARCHOPTS=-march=athlon64 \
    FORCE_DRC_C_BACKEND= \
    PTR64=1 \
    BIGENDIAN=
endif

ifeq ($(DEB_HOST_ARCH),powerpc)
DEB_MAME_OPTS += \
    ARCHOPTS=-Upowerpc \
    FORCE_DRC_C_BACKEND=1 \
    BIGENDIAN=1
endif

%:
	dh $@

# Rules to make binarys like split get renamed to mame-split
# Closes issue #2 (http://indefero.shaperstudio.com/p/mamedeb/issues/2/)

build: build-stamp
build-stamp:
#	dh_testdir
	$(MAKE) -j3 $(DEB_MAME_OPTS) all
# To get to tools renamed
	[ -f mame-split ] || mv split mame-split
	[ -f mame-regrep ] || mv regrep mame-regrep
	[ -f mame-srcclean ] || mv srcclean mame-srcclean
	[ -f mame-src2html ] || mv src2html mame-src2html
	touch $@

clean:
	# Just before clening the sources, restore original names
	test -f mame-split || exit 0; \
	mv mame-split split
	test -f mame-regrep || exit 0; \
	mv mame-regrep regrep
	test -f mame-srcclean || exit 0; \
	mv mame-srcclean srcclean
	test -f mame-src2html || exit 0; \
	mv mame-src2html src2html
	dh_clean build-stamp
	$(MAKE) $(DEB_MAME_OPTS) clean

# Convert upstream sources from ZIP to TGZ
PACKAGE := $(shell dpkg-parsechangelog | sed -n 's/^Source: //p')
VERSION := $(shell dpkg-parsechangelog | sed -ne 's/^Version: \(.*\)-.*/\1/p')

FILEBASE = $(PACKAGE)$(VERSION)
URL = http://mamedev.org/downloader.php?&file=
AGENT = Debian package <ludomatic@gmail.com>
TMPDIR := $(shell mktemp --dry-run --directory -p .)

# Upstream zip does not have a dot in its name, so we have to cut it out
# Ugly but needed
UPSTREAM_VERSION := $(shell echo $(VERSION) | sed -e 's/\.//' )

fetch_upstream:
	wget -U '$(AGENT)' "$(URL)\
	$(PACKAGE)$(UPSTREAM_VERSION)s.zip" \
	-O $(FILEBASE)s.zip

get-orig-source: fetch_upstream
	mkdir $(TMPDIR)
	unzip $(FILEBASE)s.zip -d $(TMPDIR)
	mkdir -p $(TMPDIR)/sub/$(PACKAGE)-$(VERSION)
# Not a bug: Mame source needs to be unzipped twice
	unzip $(TMPDIR)/$(PACKAGE).zip -d $(TMPDIR)/sub/$(PACKAGE)-$(VERSION)
	tar -C $(TMPDIR)/sub -czvf $(PACKAGE)_$(VERSION).orig.tar.gz .
	rm -r $(TMPDIR)
	rm -r $(FILEBASE)s.zip

